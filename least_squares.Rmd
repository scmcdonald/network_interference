---
title: "Least Squares"
author: "Sarah McDonald"
date: "8/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(igraph)
library(tidyverse)
library(Matrix)
```




$$y^{(t + 1)} = A y^{(t)}$$


$$Y_v = F_Y A_v \implies \begin{bmatrix}
 y^{(1)} \\
  y^{(2)} \\
  \vdots \\
   y^{(t)}
\end{bmatrix} = \begin{bmatrix}
 f(y^{(0)} ) \\
  f(y^{(1)} ) \\
  \vdots \\
   f(y^{(t-1)} )
\end{bmatrix}A_v$$


$$Y_v \in \mathbb{R}^{(t-1)n \times 1}$$

$$F_Y \in \mathbb{R}^{(t-1)n \times n^2}$$

$$A_v \in \mathbb{R}^{n^2 \times 1}$$

Least Squares Solution:

$$A_v  = (F_Y^T F_Y)^{-1}F_Y^T Y_v$$


```{r}
### Data Generating Process ###
dgp <- function(N, periods, s_epsilon, s_alpha, s_beta, p_num, rho_1, rho_2, y_initial){

  p = p_num/N
  
  alpha = rnorm(N, mean = 0, sd = s_alpha)
  beta = rnorm(N, mean = 0, sd = s_beta)
  epsilon = rnorm(N, mean = 0, sd = s_epsilon)
  
  G <- erdos.renyi.game(N, p, type=c("gnp"), directed = FALSE, loops = F) %>%
      as_adjacency_matrix(sparse = F)

  Y <- matrix(nrow = N, ncol = periods + 1)
  colnames(Y) <- 0:periods

  Y[, "0"] <- y_initial

  for(t1 in 1:periods){
    
    t = t1 - 1
    
    y_t <- Y[, paste(t)]
    
    y_t1 <- alpha + beta + rho_1 * y_t + (rho_2 * G %*% y_t )+ epsilon
    
    Y[, paste(t1)] <- y_t1
    
  }

  identity = diag(N)
  
  comparison_matrix = ((rho_1 * identity) +( rho_2 *G))

  return(list(Y = Y, N = N, periods = periods, rankY = rankMatrix(Y)[1]))

}
```

```{r}
### Least Squares ###
least_squares <- function(Y){
  
  N <- dim(Y)[1]
  periods <- dim(Y)[2] - 1
  
  F_Y <- c()
  Y_v <- c()
  
  for(i in 1:periods){
    t <- Y[, paste(i - 1)]
    
    f_t <- matrix(NA, ncol = N*N, nrow = N)
    
    for(j in 1:N){
      f_t[j, ]<- c(rep(rep(0, N), j-1), t(t), rep(rep(0, N), N-j))
    }
    
    F_Y <- rbind(F_Y, f_t)
  
    Y_v <- rbind(Y_v, t(t(Y[, paste(i)])))
  
  }
  
  
  A = solve(t(F_Y) %*% F_Y) %*% t(F_Y) %*% Y_v
  
  return(A)
  
}

```


These two work:

1) $\rho_1  = seq(1/N, 1, 1/N)$

2) $\rho_1  \sim Unif(-1, 1)$


These two do not work:

3) $\rho_1  \sim N(0, 1)$

4) $\rho_1  \sim N(0.1, 1)$

The generated Y matrix for these are not full rank.





```{r, error=TRUE}
N = 10
output <- dgp(N = N, 
          periods = 111, 
          p_num = 3, 
          s_epsilon = 0, 
          s_alpha =  0, 
          s_beta = 0, 
          rho_1 = seq(1/N, 1, 1/N), 
          rho_2 = 0, 
          y_initial = rnorm(N, mean = 0, sd = 1)
          )

output$rankY
 A <- least_squares(Y = output$Y)


N = 10
output <- dgp(N = N, 
          periods = 111, 
          p_num = 3, 
          s_epsilon = 0, 
          s_alpha =  0, 
          s_beta = 0, 
          rho_1 = runif(N, -1, 1), 
          rho_2 = 0, 
          y_initial = rnorm(N, mean = 0, sd = 1)
          )
output$rankY
 A <- least_squares(Y = output$Y)


N = 10
output <- dgp(N = N, 
          periods = 111, 
          p_num = 3, 
          s_epsilon = 0, 
          s_alpha =  0, 
          s_beta = 0, 
          rho_1 = rnorm(N, 0, 1), 
          rho_2 = 0, 
          y_initial = rnorm(N, mean = 0, sd = 1)
          )
output$rankY
A <- least_squares(Y = output$Y)


N = 10
output <- dgp(N = N, 
          periods = 111, 
          p_num = 3, 
          s_epsilon = 0, 
          s_alpha =  0, 
          s_beta = 0, 
          rho_1 = rnorm(N, 0.1, 1), 
          rho_2 = 0, 
          y_initial = rnorm(N, mean = 0, sd = 1)
          )
output$rankY
A <- least_squares(Y = output$Y)
```

















```{r}
#rankMatrix(t(F_Y) %*% F_Y)
#dim(F_Y)
#s <- svd(F_Y)
#summary(s$d)
```










